@model prjVegetable.Models.CPersonWrap

@{
    ViewData["Title"] = "Details";
    Layout = "~/Views/Shared/_LayoutERP.cshtml";
}
<h1>人員詳細資料</h1>
<br />
<hr />
<div id="app">
    <div class="container">
        <div v-if="person" :key="person.fId">
            <form v-if="edit">
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fName" class="col-md-3 col-form-label">姓名：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fName" :placeholder="請輸入新姓名" v-model="person.fName">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fUbn" class="col-md-3 col-form-label">統編：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fUbn" :placeholder="請輸入新統編" v-model="person.fUbn">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fAccount" class="col-md-3 col-form-label">帳號：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fAccount" :placeholder="請輸入新帳號" v-model="person.fAccount">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fPassword" class="col-md-3 col-form-label">密碼：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPassword" :placeholder="請輸入新密碼" v-model="person.fPassword">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fGender" class="col-md-3 col-form-label">性別：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fGender" :value="person.fGender" v-model="person.fGender">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fBirth" class="col-md-3 col-form-label">生日：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="datepicker" :placeholder="person.fBirth" v-model="person.fBirth">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fPhone" class="col-md-3 col-form-label">手機號碼：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPhone" :placeholder="請輸入新手機號碼" v-model="person.fPhone">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fTel" class="col-md-3 col-form-label">家用電話：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fTel" :placeholder="請輸入新電話" v-model="person.fTel">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fAddress" class="col-md-3 col-form-label">地址：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fAddress" :placeholder="請輸入新地址" v-model="person.fAddress">
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fEmp" class="col-md-3 col-form-label">緊急聯絡人：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fEmp" :placeholder="請輸入緊急聯絡人" v-model="person.fEmp">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fEmpTel" class="col-md-3 col-form-label">緊急聯絡人電話：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fEmpTel" :placeholder="請輸入緊急聯絡人電話" v-model="person.fEmpTel" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fPermission" class="col-md-3 col-form-label">權限：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPermission" :value="person.fPermission" v-model="person.fPermission">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            @*顯示樣本*@
            <form v-else>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fName" class="col-md-3 col-form-label">姓名：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fName" :value="person.fName" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fUbn" class="col-md-3 col-form-label">統編：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fUbn" :value="person.fUbn" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fAccount" class="col-md-3 col-form-label">帳號：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fAccount" :value="person.fAccount" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fPassword" class="col-md-3 col-form-label">密碼：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPassword" :value="person.fPassword" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fGender" class="col-md-3 col-form-label">性別：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fGender" :value="person.fGender" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fBirth" class="col-md-3 col-form-label">生日：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="datepicker" :value="person.fBirth" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fPhone" class="col-md-3 col-form-label">手機號碼：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPhone" :value="person.fPhone" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fTel" class="col-md-3 col-form-label">家用電話：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fTel" :value="person.fTel" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fAddress" class="col-md-3 col-form-label">地址：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fAddress" :value="person.fAddress" readonly>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fEmp" class="col-md-3 col-form-label">緊急聯絡人：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fEmp" :value="person.fEmp" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fEmpTel" class="col-md-3 col-form-label">緊急聯絡人電話：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fEmpTel" :value="person.fEmpTel" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fPermission" class="col-md-3 col-form-label">權限：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fPermission" :value="person.fPermission" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fId" class="col-md-3 col-form-label">使用者ID：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fId" :value="person.fId" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <div class="col-6">
                        <div class="row">
                            <label for="fCreatedAt" class="col-md-3 col-form-label">創建日期：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fCreatedAt" :value="person.fCreatedAt" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <label for="fEditor" class="col-md-3 col-form-label">修改人：</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="fEditor" :value="person.fEditor" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- 返回與編輯按鈕 -->
            <div>
                <a href="#" @@click="goToIndex" class="btn btn-outline-primary">回員工與會員列表</a>
                <button v-if="person.fId" @@click="toggleEditting" class="btn btn-primary">編輯資料/取消</button>
                <button v-if="edit" @@click="savePerson" class="btn btn-success">儲存修改</button>
            </div>
        </div>

        <div v-else>
            <p>載入中...</p>
        </div>
    </div>
</div>

@section Scripts
{
    <script>
        $(function () {
            $("#datepicker").datepicker();
        });
    </script>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    person: [],  // 用來存放從後端獲得的人員資料
                    edit: false, //啟用編輯
                };
            },
            mounted() {
                this.loadPersonId();  // 确保调用正确的 method
            },
            methods: {
                loadPersonId() {
                    // 获取当前 URL 的路径部分
                    const path = window.location.pathname;

                    // 假设 URL 路径的格式是 /Person/Details/{id}
                    const pathSegments = path.split('/'); // 将路径分割为数组

                    // 获取路径的最后一部分作为 ID
                    const personId = pathSegments[pathSegments.length - 1];
                    if (personId) {
                        axios.get(`/Person/GetPersonById/${personId}`)
                            .then(response => {
                                console.log(response.data);  // 查看 API 返回的资料
                                this.person = response.data //? [response.data] : [];  直接将返回的对象赋值给 `person`
                            })
                            .catch(error => {
                                console.error('资料加载错误', error);
                                this.person = [];  // 如果出錯，清空資料
                            });
                    } else {
                        console.error('未提供有效的 ID');
                    }
                },
                goToIndex() {
                    window.location.href = "/Person/index";  // 返回到员工与会员列表页面，或者修改为你的页面路径
                },

                toggleEditting() {
                    this.edit = !this.edit;  // 切換 edit 值
                },
                savePerson() {
                    if (this.person.fId) {
                        console.log(this.person);  // 打印数据，确认数据是否正确
                        const personData = JSON.parse(JSON.stringify(this.person))
                        axios.put(`/Person/update`, personData)
                            .then(response => {
                                // 儲存成功後處理的邏輯，例如顯示成功訊息或重新載入資料
                                alert("資料已儲存!");
                                this.toggleEditting();  // 儲存後退出編輯模式
                            })
                            .catch(error => {
                                console.error('儲存失敗', error);
                                alert("儲存資料時發生錯誤");
                            });
                    } else {
                        alert("無效的使用者ID，無法儲存資料");
                    }
                }
            }
        });

        app.mount('#app'); // 使用 Vue 3 创造并挂载应用
    </script>
}
